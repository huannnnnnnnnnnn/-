<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>To Do List</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
</head>
<body>
  <!-- ç™»å…¥æŒ‰éˆ•å€å¡Š -->
  <div id="login-container" style="text-align:center; margin-top:100px;">
    <button id="login-btn">ä½¿ç”¨ Google ç™»å…¥</button>
  </div>

  <!-- ç™»å…¥å¾Œå¾…è¾¦æ¸…å–®å€å¡Šï¼Œé è¨­éš±è— -->
  <div class="container" id="app-container" style="display:none;">
    <button id="logout-btn">ç™»å‡º</button>

    <h1>ğŸ“… å¾…è¾¦æ¸…å–®</h1>

    <div class="date-picker">
      <label for="date-select">é¸æ“‡æ—¥æœŸï¼š</label>
      <input type="date" id="date-select" />
    </div>

    <h2 id="current-date-title"></h2>

    <div class="input-group">
      <input type="text" id="todo-input" placeholder="è¼¸å…¥å¾…è¾¦äº‹é …" />
      <button id="add-btn">æ–°å¢</button>
    </div>

    <ul id="todo-list"></ul>

    <div id="counter">å°šæœ‰ <span id="count">0</span> é …æœªå®Œæˆ</div>
  </div>

<script>
  // ======= Firebase åˆå§‹åŒ– =======
  const firebaseConfig = {
    apiKey: "AIzaSyBaY3yJ2f_YiRG-NItSmROpILa8NfBXzgE",
    authDomain: "date-251d9.firebaseapp.com",
    projectId: "date-251d9",
    storageBucket: "date-251d9.firebasestorage.app",
    messagingSenderId: "134417666337",
    appId: "1:134417666337:web:96bb4367fd6e7ecb2fee60",
    measurementId: "G-MKJ1L8JV7C"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const loginBtn = document.getElementById("login-btn");
  const logoutBtn = document.getElementById("logout-btn");
  const loginContainer = document.getElementById("login-container");
  const appContainer = document.getElementById("app-container");

  let userId = null;

  // ç›£è½ç™»å…¥ç‹€æ…‹æ”¹è®Š
  auth.onAuthStateChanged((user) => {
    if (user) {
      userId = user.uid;
      loginContainer.style.display = "none";
      appContainer.style.display = "block";
      selectedDate = getTodayString();
      dateInput.value = selectedDate;
      updateDateDisplay();
      loadTodos(selectedDate);
    } else {
      userId = null;
      loginContainer.style.display = "block";
      appContainer.style.display = "none";
    }
  });

  // Google ç™»å…¥
  loginBtn.addEventListener("click", () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(console.error);
  });

  // ç™»å‡º
  logoutBtn.addEventListener("click", () => {
    auth.signOut();
  });

  // ======= ä»‹é¢å…ƒä»¶ =======
  const dateInput = document.getElementById("date-select");
  const currentDateTitle = document.getElementById("current-date-title");
  const addBtn = document.getElementById("add-btn");
  const todoInput = document.getElementById("todo-input");
  const todoList = document.getElementById("todo-list");
  const countDisplay = document.getElementById("count");

  let selectedDate = getTodayString();

  dateInput.addEventListener("change", () => {
    selectedDate = dateInput.value;
    updateDateDisplay();
    loadTodos(selectedDate);
  });

  addBtn.addEventListener("click", addTodo);
  todoInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") addTodo();
  });

  let todos = [];

  // æ–°å¢å¾…è¾¦äº‹é …
  function addTodo() {
    const text = todoInput.value.trim();
    if (!text || !userId) return;

    const newTodo = {
      text,
      completed: false,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    };

    db.collection("users")
      .doc(userId)
      .collection("todos")
      .doc(selectedDate)
      .collection("items")
      .add(newTodo)
      .then(() => {
        todoInput.value = "";
        loadTodos(selectedDate);
      })
      .catch(console.error);
  }

  // è¼‰å…¥æŒ‡å®šæ—¥æœŸå¾…è¾¦äº‹é …
  function loadTodos(date) {
    if (!userId) return;

    db.collection("users")
      .doc(userId)
      .collection("todos")
      .doc(date)
      .collection("items")
      .orderBy("createdAt", "asc")
      .get()
      .then((querySnapshot) => {
        todos = [];
        querySnapshot.forEach((doc) => {
          todos.push({ id: doc.id, ...doc.data() });
        });
        renderList();
      })
      .catch(console.error);
  }

  // æ¸²æŸ“æ¸…å–®åˆ°ç•«é¢
  function renderList() {
    todoList.innerHTML = "";

    const incomplete = todos.filter((t) => !t.completed);
    const complete = todos.filter((t) => t.completed);
    const sorted = [...incomplete, ...complete];

    sorted.forEach((todo) => {
      const li = document.createElement("li");
      if (todo.completed) li.classList.add("completed");

      const span = document.createElement("span");
      span.textContent = todo.text;

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "åˆªé™¤";
      deleteBtn.className = "delete-btn";

      deleteBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        deleteTodo(todo.id);
      });

      li.addEventListener("click", () => {
        toggleComplete(todo.id, !todo.completed);
      });

      li.appendChild(span);
      li.appendChild(deleteBtn);
      todoList.appendChild(li);
    });

    countDisplay.textContent = incomplete.length;
  }

  // åˆªé™¤å¾…è¾¦
  function deleteTodo(id) {
    if (!userId) return;

    db.collection("users")
      .doc(userId)
      .collection("todos")
      .doc(selectedDate)
      .collection("items")
      .doc(id)
      .delete()
      .then(() => {
        loadTodos(selectedDate);
      })
      .catch(console.error);
  }

  // åˆ‡æ›å®Œæˆç‹€æ…‹
  function toggleComplete(id, completed) {
    if (!userId) return;

    db.collection("users")
      .doc(userId)
      .collection("todos")
      .doc(selectedDate)
      .collection("items")
      .doc(id)
      .update({ completed })
      .then(() => {
        loadTodos(selectedDate);
      })
      .catch(console.error);
  }

  function updateDateDisplay() {
    currentDateTitle.textContent = `ğŸ“Œ ${selectedDate} çš„å¾…è¾¦äº‹é …`;
  }

  function getTodayString() {
    const today = new Date();
    return today.toISOString().split("T")[0];
  }
</script>
</body>
</html>
